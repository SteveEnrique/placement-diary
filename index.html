<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RKMVC Placement Diary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { rkm: { maroon: '#800000', gold: '#FFC107', cream: '#FFFDD0' } }, fontFamily: { serif: ['"Noto Serif"', 'serif'], sans: ['"Noto Sans"', 'sans-serif'] } } }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Noto+Serif:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans', sans-serif; }
        h1, h2, h3, .brand-font { font-family: 'Noto Serif', serif; }
        @media print { .no-print { display: none !important; } .print-break-inside-avoid { break-inside: avoid; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        // 1. ONLY IMPORT APP AND FIRESTORE (No Auth)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // 2. CONFIGURATION (Hardcoded from your screenshot)
        const HARDCODED_CONFIG = {
            apiKey: "AIzaSyAIIlLfjh265a8cDtUmDaukEst2s12GqvME",
            authDomain: "rkmvc-placement-2025-2026.firebaseapp.com",
            projectId: "rkmvc-placement-2025-2026",
            storageBucket: "rkmvc-placement-2025-2026.firebasestorage.app",
            messagingSenderId: "886169557208",
            appId: "1:886169557208:web:2e69a76784a587a9e79fac",
            measurementId: "G-3V10HBH51Y"
        };

        const APP_COLLECTION_ID = "rkmvc-placement-diary-live-v2";
        // Official Logo
        const LOGO_URL = "https://upload.wikimedia.org/wikipedia/en/thumb/7/76/Ramakrishna_Mission_Emblem.svg/1200px-Ramakrishna_Mission_Emblem.svg.png";
        
        const Icon = ({ name, size = 20, className = "" }) => { React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, []); return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>; };

        const App = () => {
            const [db, setDb] = React.useState(null);
            const [stats, setStats] = React.useState([]);
            const [diary, setDiary] = React.useState([]);
            const [isEdit, setIsEdit] = React.useState(false);
            const [modals, setModals] = React.useState({ stat: false, diary: false });
            const [formData, setFormData] = React.useState({});
            const [status, setStatus] = React.useState("Initializing...");

            // 1. Initialize DB immediately (No Login)
            React.useEffect(() => {
                try {
                    const app = initializeApp(HARDCODED_CONFIG);
                    const database = getFirestore(app);
                    setDb(database);
                    setStatus("Connected. Waiting for data...");
                } catch(e) { setStatus("Config Error: " + e.message); }
            }, []);

            // 2. Fetch Data
            React.useEffect(() => {
                if (db) {
                    // Simplest query possible
                    const q1 = collection(db, 'artifacts', APP_COLLECTION_ID, 'public', 'data', 'placement_stats');
                    const q2 = collection(db, 'artifacts', APP_COLLECTION_ID, 'public', 'data', 'placement_diary');

                    const unsub1 = onSnapshot(q1, 
                        (s) => {
                            setStats(s.docs.map(d => ({id:d.id, ...d.data()})));
                            setStatus("Data Loaded");
                        },
                        (e) => setStatus("Read Error: " + e.message)
                    );

                    const unsub2 = onSnapshot(q2, (s) => setDiary(s.docs.map(d => ({id:d.id, ...d.data()}))));
                    return () => { unsub1(); unsub2(); };
                }
            }, [db]);

            // Sort Data in Browser
            const sortedStats = [...stats].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            const sortedDiary = [...diary].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

            const getNum = (v) => { const n = parseInt(String(v).replace(/\D/g,'')); return isNaN(n)?0:n; };

            const addRecord = async (type) => {
                if (!db) return alert("Database not connected");
                try {
                    await addDoc(collection(db, 'artifacts', APP_COLLECTION_ID, 'public', 'data', type), { ...formData, createdAt: serverTimestamp() });
                    alert("Saved Successfully!");
                    setModals({ stat: false, diary: false });
                    setFormData({});
                } catch (e) {
                    alert("SAVE FAILED: " + e.message + "\n\nCheck Firebase Console > Rules. Must be 'allow read, write: if true;'");
                }
            };

            const deleteRecord = async (id, type) => {
                if (confirm("Delete this record?")) {
                     try {
                        await deleteDoc(doc(db, 'artifacts', APP_COLLECTION_ID, 'public', 'data', type, id));
                     } catch(e) { alert("Delete Failed: " + e.message); }
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <nav className="sticky top-0 z-40 bg-white shadow-md border-b-4 border-rkm-gold no-print">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center space-x-4">
                                <img src={LOGO_URL} className="h-16 w-auto" onError={(e)=>e.target.style.display='none'}/>
                                <div className="hidden md:block">
                                    <h1 className="text-rkm-maroon font-bold text-xl uppercase">Ramakrishna Mission</h1>
                                    <h2 className="text-rkm-gold font-bold text-2xl uppercase" style={{textShadow:'1px 1px 0 #800000'}}>Vivekananda College</h2>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => window.print()} className="px-3 py-2 bg-rkm-maroon text-white rounded font-bold text-xs uppercase"><Icon name="printer" size={16}/> Print</button>
                                <button onClick={() => setIsEdit(!isEdit)} className={`p-2 rounded border-2 ${isEdit ? 'bg-rkm-gold' : 'bg-slate-100'}`}><Icon name={isEdit?"unlock":"lock"} size={18}/></button>
                            </div>
                        </div>
                    </nav>

                    <div className="bg-rkm-maroon text-white py-20 text-center no-print shadow-inner relative">
                        <div className="absolute inset-0 opacity-10" style={{backgroundImage:'radial-gradient(#FFC107 2px, transparent 2px)', backgroundSize:'30px 30px'}}></div>
                        <div className="relative z-10">
                            <h1 className="text-4xl md:text-6xl font-bold mb-4 font-serif">Placement Diary <span className="text-rkm-gold">2025-2026</span></h1>
                            <div className="flex justify-center gap-8 mt-8">
                                <div className="bg-white/10 p-4 rounded border-l-2 border-rkm-gold text-center"><div className="text-3xl font-bold">{stats.reduce((a,c)=>a+getNum(c.selected),0)}</div><div className="text-[10px] uppercase text-rkm-gold font-bold">Offers</div></div>
                                <div className="bg-white/10 p-4 rounded border-l-2 border-rkm-gold text-center"><div className="text-3xl font-bold">{new Set(stats.map(s=>s.company)).size}</div><div className="text-[10px] uppercase text-rkm-gold font-bold">Companies</div></div>
                            </div>
                        </div>
                    </div>

                    <main className="max-w-7xl mx-auto px-4 py-12 w-full flex-grow">
                        {/* STATS SECTION */}
                        <div className="flex justify-between items-end mb-6 border-b pb-2">
                            <h2 className="text-2xl font-bold text-rkm-maroon font-serif">Statistics</h2>
                            {isEdit && <button onClick={() => {setFormData({}); setModals({...modals, stat: true})}} className="bg-rkm-maroon text-white px-3 py-1 rounded text-sm">+ Add Record</button>}
                        </div>
                        
                        <div className="overflow-x-auto border rounded mb-12 shadow-sm">
                            <table className="w-full text-sm text-left whitespace-nowrap">
                                <thead className="bg-rkm-maroon text-white"><tr><th className="p-3">Date</th><th className="p-3">Company</th><th className="p-3">Mode</th><th className="p-3">Apt</th><th className="p-3">GD</th><th className="p-3">Tech</th><th className="p-3">HR</th><th className="p-3">Selected</th>{isEdit && <th className="p-3"></th>}</tr></thead>
                                <tbody>
                                    {stats.length === 0 && <tr><td colSpan="9" className="p-8 text-center text-slate-500">No records found. Click + Add to start.</td></tr>}
                                    {sortedStats.map(s => (
                                        <tr key={s.id} className="border-b hover:bg-amber-50">
                                            <td className="p-3 font-mono">{s.date}</td><td className="p-3 font-bold text-rkm-maroon">{s.company}</td><td className="p-3">{s.mode}</td>
                                            <td className="p-3 text-center">{s.aptitude}</td><td className="p-3 text-center">{s.gd}</td><td className="p-3 text-center">{s.tech}</td><td className="p-3 text-center">{s.hr}</td>
                                            <td className="p-3 font-bold text-green-700 bg-green-50 text-center">{s.selected}</td>
                                            {isEdit && <td className="p-3"><button onClick={()=>deleteRecord(s.id, 'placement_stats')} className="text-red-500"><Icon name="trash-2" size={16}/></button></td>}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* DIARY SECTION */}
                        <div className="flex justify-between items-end mb-6 border-b pb-2">
                            <h2 className="text-2xl font-bold text-rkm-maroon font-serif">Diary Events</h2>
                            {isEdit && <button onClick={() => {setFormData({}); setModals({...modals, diary: true})}} className="bg-rkm-maroon text-white px-3 py-1 rounded text-sm">+ Add Event</button>}
                        </div>

                        <div className="space-y-6">
                            {diary.length === 0 && <div className="text-center text-slate-500 py-12 border border-dashed rounded">No events logged yet.</div>}
                            {sortedDiary.map(d => (
                                <div key={d.id} className="bg-white border-l-4 border-rkm-gold shadow-sm p-6 rounded relative break-inside-avoid">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="text-xl font-bold text-rkm-maroon font-serif mb-2">{d.title}</h3>
                                            <div className="text-xs font-bold text-slate-500 mb-4 flex items-center"><Icon name="calendar" size={12} className="mr-1"/> {d.date} &nbsp;|&nbsp; <Icon name="map-pin" size={12} className="mr-1"/> {d.location}</div>
                                        </div>
                                        {isEdit && <button onClick={()=>deleteRecord(d.id, 'placement_diary')} className="text-slate-300 hover:text-red-600"><Icon name="trash-2" size={20}/></button>}
                                    </div>
                                    <p className="text-sm text-slate-700 whitespace-pre-wrap mb-4 leading-relaxed">{d.desc}</p>
                                    {d.image && <img src={d.image} className="w-full md:w-64 h-40 object-cover rounded border" onError={(e)=>e.target.style.display='none'} />}
                                </div>
                            ))}
                        </div>
                    </main>

                    <footer className="bg-rkm-maroon text-white py-8 text-center no-print border-t-4 border-rkm-gold">
                        <p>Â© 2025 Ramakrishna Mission Vivekananda College</p>
                        <div className="text-[10px] opacity-50 mt-2">{status}</div>
                    </footer>

                    {/* MODALS */}
                    {modals.stat && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded w-full max-w-md m-4">
                                <h3 className="text-xl font-bold mb-4 text-rkm-maroon">Add Statistic</h3>
                                <div className="grid gap-3">
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="date" className="border p-2 rounded w-full" onChange={e=>setFormData({...formData, date: e.target.value})} />
                                        <select className="border p-2 rounded w-full" onChange={e=>setFormData({...formData, mode: e.target.value})}><option>Physical</option><option>Virtual</option><option>Mixed</option></select>
                                    </div>
                                    <input placeholder="Company Name" className="border p-2 rounded w-full" onChange={e=>setFormData({...formData, company: e.target.value})} />
                                    <div className="grid grid-cols-4 gap-2">
                                        <input placeholder="Apt" className="border p-2 rounded text-center" onChange={e=>setFormData({...formData, aptitude: e.target.value})} />
                                        <input placeholder="GD" className="border p-2 rounded text-center" onChange={e=>setFormData({...formData, gd: e.target.value})} />
                                        <input placeholder="Tech" className="border p-2 rounded text-center" onChange={e=>setFormData({...formData, tech: e.target.value})} />
                                        <input placeholder="HR" className="border p-2 rounded text-center" onChange={e=>setFormData({...formData, hr: e.target.value})} />
                                    </div>
                                    <input placeholder="Selected (Offers)" className="border p-2 rounded w-full bg-green-50 font-bold" onChange={e=>setFormData({...formData, selected: e.target.value})} />
                                    <div className="flex gap-2 mt-2">
                                        <button onClick={()=>addRecord('placement_stats')} className="bg-rkm-maroon text-white p-2 rounded flex-1">Save</button>
                                        <button onClick={()=>setModals({...modals, stat:false})} className="border text-slate-500 p-2 rounded flex-1">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modals.diary && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded w-full max-w-md m-4">
                                <h3 className="text-xl font-bold mb-4 text-rkm-maroon">Add Diary Event</h3>
                                <div className="grid gap-3">
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="date" className="border p-2 rounded w-full" onChange={e=>setFormData({...formData, date: e.target.value})} />
                                        <input placeholder="Location" className="border p-2 rounded w-full" onChange={e=>setFormData({...formData, location: e.target.value})} />
                                    </div>
                                    <input placeholder="Event Title" className="border p-2 rounded w-full" onChange={e=>setFormData({...formData, title: e.target.value})} />
                                    <textarea placeholder="Description" className="border p-2 rounded w-full h-32" onChange={e=>setFormData({...formData, desc: e.target.value})}></textarea>
                                    <input placeholder="Image URL (https://...)" className="border p-2 rounded w-full" onChange={e=>setFormData({...formData, image: e.target.value})} />
                                    <div className="flex gap-2 mt-2">
                                        <button onClick={()=>addRecord('placement_diary')} className="bg-rkm-maroon text-white p-2 rounded flex-1">Save</button>
                                        <button onClick={()=>setModals({...modals, diary:false})} className="border text-slate-500 p-2 rounded flex-1">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
